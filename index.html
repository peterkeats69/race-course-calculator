<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Multi Course Race Calculator — Beta 3M</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="manifest" href="./manifest.webmanifest">
<meta name="theme-color" content="#0d355f">
<style>
  body{font-family:Arial,system-ui,-apple-system,Segoe UI,Roboto,sans-serif;margin:12px}
  h2{margin:0 0 4px 0}
  .build{font-size:14px;color:#444;margin:0 0 14px 0}
  .row{display:flex;gap:16px;flex-wrap:wrap;align-items:flex-end}
  label{display:block;margin-top:12px;font-size:18px;font-weight:800}
  input,select{width:240px;max-width:100%;padding:12px;font-size:22px;font-weight:800;border:2px solid #333;border-radius:10px}
  input[type="checkbox"]{width:auto}
  .section{margin-top:18px}
  .card{border:2px solid #0d355f;border-radius:12px;padding:12px;margin-bottom:10px;background:#f7f9fb}
  .line1{font-size:22px;font-weight:900;color:#003366;letter-spacing:.2px}
  .line2{font-size:20px;font-weight:900;color:#000;margin-top:4px}
  .muted{font-size:14px;color:#555;font-weight:700}
  .hidden{display:none!important}
  .footer{text-align:center;margin:22px 0 8px 0;font-size:14px;color:#555}
  @media(max-width:760px){
    .row{flex-direction:column;align-items:stretch;gap:0}
    input,select{width:100%}
  }
</style>
</head>
<body>
<h2>Multi Course Race Calculator — Beta 3M</h2>
<p class="build">Includes: Trapezoid (60/70/80), Triangle, 90° Gybe, Windward-Leeward (with optional spreader 1a).</p>

<div class="row">
  <label>Course type
    <select id="courseType">
      <option value="trapezoid" selected>Trapezoid</option>
<option value="triangle">Triangle (equal legs)</option>
<option value="gybe90">Triangle 90° gybe (71% reaches)</option>
<option value="windwardleeward">Windward-Leeward</option>

    </select>
  </label>

  <label>Axis (°)
    <input id="axis" type="number" value="0">
  </label>

  <label>Start Line (m)
    <input id="lineLen" type="number" value="200">
  </label>

  <label>Course Length (nm)
    <input id="courseLenNm" type="number" step="0.01" value="0.60">
  </label>
</div>

<!-- Trapezoid inputs -->
<div id="trapInputs" class="row">
  <label>Angle
    <select id="trapAngle">
      <option value="60">60°</option>
      <option value="70" selected>70°</option>
      <option value="80">80°</option>
    </select>
  </label>

  <label>Gate 4 Width (m)
    <input id="gate4W" type="number" value="30">
  </label>

  <label>Gate 3 Width (m)
    <input id="gate3W" type="number" value="30">
  </label>

  <label>Upwind offset to Gate 4 centre (m)
    <input id="gateOff" type="number" value="93">
  </label>

  <label>Reach % <span class="muted">(Default 67%)</span>
    <input id="reachPct" type="number" step="0.1" value="67">
  </label>

  <label>Reach (nm)
    <input id="reachNm" type="number" step="0.01">
  </label>
</div>

<!-- Hybrid Gate 4 (trapezoid only) -->
<div id="hybridRow" class="row">
  <label style="font-weight:900">
    <input type="checkbox" id="hybOn" style="transform:scale(1.2);margin-right:8px">
    Enable Hybrid Gate 4
  </label>
  <label id="hybMwrap" class="hidden">Hybrid leg 4P→1 (m)
    <input id="hybLegM" type="number" value="0">
  </label>
  <label id="hybNmwrap" class="hidden">Hybrid leg 4P→1 (nm)
    <input id="hybLegNm" type="number" step="0.01" value="0.00">
  </label>
</div>

<!-- Windward-Leeward inputs -->
<div id="wlInputs" class="row hidden">
  <label>Gate 4 Width (m)
    <input id="wlGate4W" type="number" value="30">
  </label>
  <label>Upwind offset to Gate 4 centre (m)
    <input id="wlGateOff" type="number" value="93">
  </label>

  <label style="font-weight:900">
    <input type="checkbox" id="wlUseSp" style="transform:scale(1.2);margin-right:8px">
    Use Spreader 1a
  </label>

  <label id="wlDistMwrap" class="hidden">1→1a distance (m)
    <input id="wlDistM" type="number" value="50">
  </label>
  <label id="wlDistNmwrap" class="hidden">1→1a distance (nm)
    <input id="wlDistNm" type="number" step="0.01" value="0.03">
  </label>
  <label id="wlAngWrap" class="hidden">1→1a angle left of axis (°)
    <input id="wlAng" type="number" step="0.1" value="30">
  </label>

  <label id="wlPerfectWrap" class="hidden" style="font-weight:900">
    <input type="checkbox" id="wlPerfect" style="transform:scale(1.2);margin-right:8px">
    Perfect run (Gate4C→1a = Axis)
  </label>
</div>

<div class="section" id="results"></div>
<div class="footer">Multi Course Race Calculator — Beta 3M © Peter Keats 2025</div>

<script>
// ---- helpers ----
function toRad(d){return d*Math.PI/180}
function norm(d){return (d%360+360)%360}
function vec(b){return {x:Math.sin(toRad(b)), y:Math.cos(toRad(b))}}
function add(p,q){return {x:p.x+q.x, y:p.y+q.y}}
function scale(v,s){return {x:v.x*s, y:v.y*s}}
function dist(p,q){const dx=q.x-p.x, dy=q.y-p.y; return Math.hypot(dx,dy)}
function brg(p,q){const dx=q.x-p.x, dy=q.y-p.y; return norm(Math.atan2(dx,dy)*180/Math.PI)}
function card(a,b,A,B){
  const d=dist(A,B), b1=brg(A,B), b2=brg(B,A);
  return `<div class="card">
    <div class="line1">${a}→${b}: ${b1.toFixed(0)}° | ${b}→${a}: ${b2.toFixed(0)}°</div>
    <div class="line2">${Math.round(d)} m | ${(d/1852).toFixed(2)} nm</div>
  </div>`;
}
function dirsTrapezoid(angle){
  angle=Number(angle);
  if(angle===60) return {b41:0,b12:240,b23:180,b34:60};
  if(angle===80) return {b41:0,b12:260,b23:180,b34:80};
  return {b41:0,b12:250,b23:180,b34:70}; // 70°
}

// ---- reach sync ----
let syncing=false;
function syncReachFromPct(){
  if(syncing) return; syncing=true;
  const lenNm=+el('courseLenNm').value||0;
  const pct=+el('reachPct').value||0;
  el('reachNm').value=(lenNm*(pct/100)).toFixed(2);
  syncing=false; compute();
}
function syncReachFromNm(){
  if(syncing) return; syncing=true;
  const lenNm=+el('courseLenNm').value||0;
  const nm=+el('reachNm').value||0;
  el('reachPct').value = lenNm>0 ? ((nm/lenNm)*100).toFixed(1) : "0.0";
  syncing=false; compute();
}

// ---- hybrid sync ----
function syncHybrid(from){
  const mEl=el('hybLegM'), nmEl=el('hybLegNm');
  if(from==='m'){ const m=+mEl.value||0; nmEl.value=(m/1852).toFixed(2); }
  else { const nm=+nmEl.value||0; mEl.value=Math.round(nm*1852); }
  compute();
}

// ---- WL spreader sync ----
function syncWL(from){
  const mEl=el('wlDistM'), nmEl=el('wlDistNm');
  if(from==='m'){ const m=+mEl.value||0; nmEl.value=(m/1852).toFixed(2); }
  else { const nm=+nmEl.value||0; mEl.value=Math.round(nm*1852); }
  compute();
}

function el(id){ return document.getElementById(id); }

function show(id,on){ el(id).classList.toggle('hidden', !on); }

function compute(){
  const t=el('courseType').value;
  const axis=+el('axis').value||0;
  const lineLen=+el('lineLen').value||200;
  const courseNm=+el('courseLenNm').value||0.60;
  const lenM=courseNm*1852;

  // Show/hide input panels
  show('trapInputs', t==='trapezoid');
  show('hybridRow', t==='trapezoid');
  show('wlInputs', t==='windwardleeward');

  // hybrid field visibility
  const hybOn = el('hybOn').checked;
  show('hybMwrap', t==='trapezoid' && hybOn);
  show('hybNmwrap', t==='trapezoid' && hybOn);

  // WL spreader field visibility
  const wlUse = el('wlUseSp').checked;
  show('wlDistMwrap', t==='windwardleeward' && wlUse);
  show('wlDistNmwrap', t==='windwardleeward' && wlUse);
  show('wlAngWrap', t==='windwardleeward' && wlUse);
  show('wlPerfectWrap', t==='windwardleeward' && wlUse);

  // Base geometry: CB at origin, start line runs left (axis-90)
  const pCB={x:0,y:0};
  const uL=vec(axis-90);      // from CB to pin (left looking upwind)
  const pPin=add(pCB, scale(uL, lineLen));
  const pMid=add(pCB, scale(uL, lineLen/2));
  const uA=vec(axis);         // upwind
  const uR=vec(axis+90);      // right looking upwind

  let html = `<div class="section"><h3>Start Line</h3>${card("CB","Pin",pCB,pPin)}</div>`;

  if(t==='trapezoid'){
    const ang=el('trapAngle').value;
    const gw=+el('gate4W').value||30;
    const g3w=+el('gate3W').value||30;
    const off=+el('gateOff').value||93;

    // reach defaults/sync
    let rNm=parseFloat(el('reachNm').value);
    const pct=+el('reachPct').value||67;
    if(!(rNm>0)) rNm = courseNm*(pct/100);
    const rM=rNm*1852;

    const d=dirsTrapezoid(ang);
    const u41=vec(axis+d.b41);
    const u12=vec(axis+d.b12);
    const u23=vec(axis+d.b23);

    // Gate 4 (Simple, start-line anchored)
    const gateC = add(pMid, scale(uA, off));
    const p4P = add(gateC, scale(uR, gw/2));

    // Marks
    const p1 = add(p4P, scale(u41, lenM));
    const p2 = add(p1,  scale(u12, rM));
    const p3C= add(p2,  scale(u23, lenM));
    const p3P= add(p3C, scale(uR, g3w/2));

    html += `<div class="section"><h3>CB Reference (Trapezoid)</h3>
      ${card("CB","4P",pCB,p4P)}${card("CB","1",pCB,p1)}${card("CB","2",pCB,p2)}${card("CB","3P",pCB,p3P)}
    </div>`;

    if(hybOn){
      let legM=+el('hybLegM').value;
      const legNm=+el('hybLegNm').value;
      if(!(legM>0) && legNm>0) legM=Math.round(legNm*1852);
      if(legM<0) legM=0; if(legM>lenM) legM=lenM;

      const pH4P = add(p1, scale(u41, -legM));
      html += `<div class="section"><h3>Hybrid Gate 4</h3>
        ${card("CB","Hybrid 4P",pCB,pH4P)}${card("Hybrid 4P","1",pH4P,p1)}
      </div>`;
    }

    html += `<div class="section"><h3>Course Legs</h3>
      ${card("4P","1",p4P,p1)}
      ${card("1","2",p1,p2)}
      ${card("2","3P",p2,p3P)}
      ${card("4P","3P",p4P,p3P)}
    </div>`;
  }

  if(t==='triangle'){
    // Mark 3: 50m ahead of CB, centered ahead of start line (use pMid + axis*50)
    const p3 = add(pMid, scale(uA, 50));
    const p1 = add(p3, scale(uA, lenM));
    const u12 = vec(axis+240);
    const p2 = add(p1, scale(u12, lenM));

    html += `<div class="section"><h3>CB Reference (Triangle)</h3>
      ${card("CB","1",pCB,p1)}${card("CB","2",pCB,p2)}${card("CB","3",pCB,p3)}
    </div>
    <div class="section"><h3>Course Legs</h3>
      ${card("3","1",p3,p1)}${card("1","2",p1,p2)}${card("2","3",p2,p3)}
    </div>`;
  }

  if(t==='gybe90'){
    // Mark 3: 50m ahead of CB
    const p3 = add(pMid, scale(uA, 50));
    const p1 = add(p3, scale(uA, lenM));
    const rM = lenM*0.71;
    const p2 = add(p1, scale(vec(axis+225), rM));

    html += `<div class="section"><h3>CB Reference (90° Gybe)</h3>
      ${card("CB","1",pCB,p1)}${card("CB","2",pCB,p2)}${card("CB","3",pCB,p3)}
    </div>
    <div class="section"><h3>Course Legs</h3>
      ${card("3","1",p3,p1)}${card("1","2",p1,p2)}${card("2","3",p2,p3)}
    </div>`;
  }

  if(t==='windwardleeward'){
    const gw=+el('wlGate4W').value||30;
    const off=+el('wlGateOff').value||93;

    // Gate 4 (Simple, start-line anchored)
    const gateC = add(pMid, scale(uA, off));
    const p4P = add(gateC, scale(uR, gw/2));

    // Base 1a position on axis above gate centre (used in perfect run)
    const pAxisTop = add(gateC, scale(uA, lenM));

    // Mark 1 initial (normal mode)
    let p1 = pAxisTop;

    const useSp = el('wlUseSp').checked;
    let p1a = null;

    if(useSp){
      let dM = +el('wlDistM').value;
      const dNm = +el('wlDistNm').value;
      if(!(dM>0) && dNm>0) dM=Math.round(dNm*1852);

      const ang=+el('wlAng').value||0;        // degrees left of axis
      const u1a=vec(axis - ang);              // direction from 1 to 1a (left of axis)

      if(el('wlPerfect').checked){
        // Perfect run: Gate4C→1a = Axis
        p1a = pAxisTop;
        p1  = add(p1a, scale(u1a, -dM));      // move 1 to keep distance/angle
      } else {
        p1a = add(p1, scale(u1a, dM));
      }
    }

    html += `<div class="section"><h3>CB Reference (Windward-Leeward)</h3>
      ${card("CB","4P",pCB,p4P)}${card("CB","1",pCB,p1)}${useSp ? card("CB","1a",pCB,p1a) : ""}
    </div>`;

    html += `<div class="section"><h3>Course Legs</h3>
      ${card("4P","1",p4P,p1)}
      ${useSp ? card("1","1a",p1,p1a) : ""}
      ${useSp ? card("1a","4P",p1a,p4P) : card("1","4P",p1,p4P)}
    </div>`;
  }

  el('results').innerHTML = html;
}

// ---- events ----
['courseType','axis','lineLen',
 'trapAngle','gate4W','gate3W','gateOff',
 'wlGate4W','wlGateOff','wlAng'
].forEach(id=>{
  const e=el(id);
  if(!e) return;
  e.addEventListener('input', compute);
  e.addEventListener('change', compute);
});

// Keep reach % consistent when course length changes (trapezoid)
el('courseLenNm').addEventListener('input', ()=>{
  if(el('courseType').value==='trapezoid') syncReachFromPct();
  else compute();
});
el('courseLenNm').addEventListener('change', ()=>{
  if(el('courseType').value==='trapezoid') syncReachFromPct();
  else compute();
});

el('reachPct').addEventListener('input', syncReachFromPct);
el('reachNm').addEventListener('input', syncReachFromNm);

el('hybOn').addEventListener('change', compute);
el('hybLegM').addEventListener('input', ()=>syncHybrid('m'));
el('hybLegNm').addEventListener('input', ()=>syncHybrid('nm'));

el('wlUseSp').addEventListener('change', compute);
el('wlPerfect').addEventListener('change', compute);
el('wlDistM').addEventListener('input', ()=>syncWL('m'));
el('wlDistNm').addEventListener('input', ()=>syncWL('nm'));

// Init reach nm from default percent
syncReachFromPct();

// PWA SW registration (safe if already present)
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('./sw.js').catch(()=>{});
  });
}
</script>
</body>
</html>
